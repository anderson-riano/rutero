{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<style>
    .input-group-addon {
        color: #00f2c3;
        border-color: #00f2c3;
        border: none
    }

    .input-group-addon:focus {
        outline: 0 !important
    }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="content">
    <div class="row"></div>
    {# <h1>Hello {{ firstname }}</h1> #}
    <form id="formGrafica">
        {% csrf_token %}

        {% for error in errors  %}
        <div class="alert alert-danger mb-4" role="alert">
            <strong>{{ error }}</strong>
        </div>
        {% endfor %}

        <div class="row">
            <div class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione Plataforma IoT</label>
                        {{ form.platafromas}}
                    </div>
                </div>
            </div>
            <div id="divRed" class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione Red</label>
                        <select id="id_red" class="form-control selectpicker" data-live-search="true" data-style="btn-success" name="state">
                            <option selected disabled value="0">Seleccione</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione estación/dispositivo/equipo</label>
                        <select id="id_dispositivo" class="form-control selectpicker" data-live-search="true" data-style="btn-success" name="state">
                            <option selected disabled value="0">Seleccione</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione sensor/variable</label>
                        <select id="id_sensor" class="form-control selectpicker" data-live-search="true" data-style="btn-success" name="state">
                            <option selected disabled value="0">Seleccione</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione fecha inicial y final</label>
                        {# <div class="input-group date datepicker" data-date-format="yyyy-mm-dd"> #}
                        {# <input type="text" class="form-control" data-style="btn-success" id="day" name="day" placeholder="yyyy-mm-dd"> #}
                        <div class="input-group input-daterange">
                            <span class="input-group-addon"><i class="tim-icons icon-calendar-60"></i></span>
                            <input type="text" class="start-date form-control" data-style="btn-success" id="dateIni" name="dateIni" value="2023-04-01">
                            <div class="input-group-addon"><i class="tim-icons icon-calendar-60"></i></div>
                            <input type="text" class="end-date form-control" data-style="btn-success" id="dateFin" name="dateFin" value="2023-04-30">
                        </div>

                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Incluir datos de todos los sensores de la estación en la descarga </label>
                        <div class="form-check">
                            <label class="form-check-label">
                                Si
                                <input id="todoSensor" class="form-check-input" type="checkbox" value="1">
                                <span class="form-check-sign">
                                    <span class="check"></span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class=" row justify-content-md-center">
            <div class="col-lg-4">
                <input type="button" value="Graficar" class="form-control btn btn-success" id="form_btn">
            </div>
            <div class="col-lg-4">
                <input type="button" value="Descargar Excel" class="form-control btn btn-success" id="excel_btn">
            </div>
        </div>

    </form>
    <br>
    <div class="graficas1">
        <div class="row">
            <div class="col-12">
                <div class="card card-chart">
                    <div class="card-header ">
                        <div class="row">
                            <div class="col-sm-6 text-left">
                                <h2 id="title-sensor-bar" class="card-title">Performance</h2>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="chartBar"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="graficas">
        <div class="row">
            <div class="col-12">
                <div class="card card-chart">
                    <div class="card-header ">
                        <div class="row">
                            <div class="col-sm-6 text-left">
                                <h2 id="title-sensor-line" class="card-title">Performance</h2>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="chartLine"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="graficaMulti">
        <div class="row">
            <div class="col-12">
                <div class="card card-chart">
                    <div class="card-body">
                        <div id="chart-graficaMulti" class="highcharts-background">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #chart-graficaMulti {
        height: 500px;
    }

    .highcharts-figure,
    .highcharts-data-table table {
        min-width: 310px;
        max-width: 800px;
        margin: 1em auto;
    }

    .highcharts-data-table table {
        font-family: Verdana, sans-serif;
        border-collapse: collapse;
        border: 1px solid #ebebeb;
        margin: 10px auto;
        text-align: center;
        width: 100%;
        max-width: 500px;
    }

    .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
    }

    .highcharts-data-table th {
        font-weight: 600;
        padding: 0.5em;
    }

    .highcharts-data-table td,
    .highcharts-data-table th,
    .highcharts-data-table caption {
        padding: 0.5em;
    }

    .highcharts-data-table thead tr,
    .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
    }

    .highcharts-data-table tr:hover {
        background: #f1f7ff;
    }

    .highcharts-background {
        fill: #ffffff00;
    }
</style>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
    var x = 'hola';
    var chart_chartBig1;
    var medida;

    $(document).ready(function() {
        // Javascript method's body can be found in assets/js/demos.js
        $(".graficas").hide()
        $(".graficas1").hide()
        $(".graficaMulti").hide()
        $("#divRed").hide();

        $('.start-date').datepicker({
            templates: {
                leftArrow: '<i class="fa fa-chevron-left"></i>',
                rightArrow: '<i class="fa fa-chevron-right"></i>'
            },
            format: "yyyy-mm-dd",
            startDate: '2023-04-01',
            keyboardNavigation: false,
            autoclose: true,
            todayHighlight: true,
            disableTouchKeyboard: true,
            orientation: "bottom auto"
        });

        $('.end-date').datepicker({
            templates: {
                leftArrow: '<i class="fa fa-chevron-left"></i>',
                rightArrow: '<i class="fa fa-chevron-right"></i>'
            },
            format: "yyyy-mm-dd",
            startDate: '2023-04-01',
            keyboardNavigation: false,
            autoclose: true,
            todayHighlight: true,
            disableTouchKeyboard: true,
            orientation: "bottom auto"

        });


        $('.start-date').datepicker().on("changeDate", function() {
            var startDate = $('.start-date').datepicker('getDate');
            var oneDayFromStartDate = '2023-04-01';
            $('.end-date').datepicker('setStartDate', oneDayFromStartDate);
            $('.end-date').datepicker('setDate', oneDayFromStartDate);
        });

        $('.end-date').datepicker().on("show", function() {
            var startDate = $('.start-date').datepicker('getDate');
            $('.day.disabled').filter(function(index) {
                return $(this).text() === moment(startDate).format('D');
            }).addClass('active');
        });

        $("#id_plataforma").change(function() {
            var plataformaId = $(this).val();

            if (plataformaId == 4) {
                $("#divRed").show();
                $.ajax({
                    type: "POST",
                    url: "{% url 'get-red' %}",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'id': plataformaId
                    },
                    success: function(data) {
                        console.log(data.datos);
                        let html_data = '<option  selected disabled value="0">Seleccione</option>';
                        data.datos.forEach(function(data) {
                            html_data += `<option value="${data[0]}">${data[1]}</option>`
                        });
                        $("#id_red").html(html_data);
                        $("#id_red").selectpicker("refresh");
                    }
                });
            } else {
                $("#divRed").hide();
                $.ajax({
                    type: "POST",
                    url: "{% url 'get-dispositivo' %}",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'id': plataformaId
                    },
                    success: function(data) {
                        console.log(data.datos);
                        let html_data = '<option  selected disabled value="0">Seleccione</option>';
                        data.datos.forEach(function(data) {
                            html_data += `<option value="${data[0]}">${data[1]}</option>`
                        });
                        $("#id_dispositivo").html(html_data);
                        $("#id_dispositivo").selectpicker("refresh");
                    }
                });
            }

        });

        $("#id_red").change(function() {
            var plataformaId = $('#id_plataforma').val();
            var redId = $('#id_red').val();

            $.ajax({
                type: "POST",
                url: "{% url 'get-dispositivo' %}",
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'id': plataformaId,
                    'id_red': redId
                },
                success: function(data) {
                    console.log(data.datos);
                    let html_data = '<option  selected disabled value="0">Seleccione</option>';
                    data.datos.forEach(function(data) {
                        html_data += `<option value="${data[0]}">${data[1]}</option>`
                    });
                    $("#id_dispositivo").html(html_data);
                    $("#id_dispositivo").selectpicker("refresh");
                }
            });

        });

        $("#id_dispositivo").change(function() {
            var dispositivoId = $(this).val();

            $.ajax({
                type: "POST",
                url: "{% url 'get-sensors' %}",
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'id': dispositivoId,
                    'id_plataforma': $('#id_plataforma').val()
                },
                success: function(data) {
                    console.log(data.datos);
                    let html_data = '<option  selected disabled value="0">Seleccione</option>';
                    data.datos.forEach(function(data) {
                        html_data += `<option value="${data[0]}">${data[1]}</option>`
                    });
                    $("#id_sensor").html(html_data);
                    $("#id_sensor").selectpicker("refresh");
                }
            });

        });

        $("#form_btn").click(function() {
            var dispositivoId = $('#id_dispositivo').val();
            var plataformaId = $('#id_plataforma').val();
            var sensorId = $('#id_sensor').val();
            var redId = $('#id_red').val();
            var dateIni = $('#dateIni').val();
            var dateFin = $('#dateFin').val();
            var todoSensor = $('#todoSensor').is(':checked');
            $.ajax({
                type: "POST",
                url: "{% url 'process-form' %}",
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'id_dispositivo': dispositivoId,
                    'id_plataforma': plataformaId,
                    'id_sensor': sensorId,
                    'id_red': redId,
                    'dateIni': dateIni,
                    'dateFin': dateFin,
                    'todoSensor': todoSensor
                },
                success: function(data) {
                    if (data.vertical.length == 0) {
                        general.showNotificationOwn('top', 'right', 'warning', 'Datos Incompletos o Sin Informacion', 'ERROR')
                        $(".graficas").hide();
                        $(".graficaMulti").hide();
                    } else {
                        // $(".graficas").show();
                        $(".graficaMulti").show();
                        $('#title-sensor-line').text('Grafico de sensor ' + $('#id_sensor option:selected').text() + ' - Fechas ' + $('#dateIni').val() + ' - ' + $('#dateFin').val());
                        // general.initLineCharts('chartLine', data.vertical, data.horizontal, "Valor del sensor " + data.medida, data.medida, 'Hora');

                        general.initMultipleAxesHighCharts('chart-graficaMulti', data.vertical, data.horizontal, data.medidas, data.sensores, ('Grafico de ' + $('#id_dispositivo option:selected').text() + ' - Fechas ' + $('#dateIni').val() + ' - ' + $('#dateFin').val()));
                    }
                    // if (data.vertical2.length == 0) {
                    //     $(".graficas1").hide()
                    // } else {
                    //     $(".graficas1").show()
                    //     $('#title-sensor-bar').text('Grafico de sensor Precipitación - Fechas ' + $('#dateIni').val() + ' - ' + $('#dateFin').val());
                    //     general.initBarCharts('chartBar', data.vertical2, data.horizontal2, "Valor del sensor " + data.medida2, data.medida2, 'Hora');
                    // }
                }
            });
        });

        $("#excel_btn").click(function() {
            general.showNotificationOwn('top', 'right', 'success', 'Excel', 'Generando', 'tim-icons icon-cloud-download-93')
            var dispositivoId = $('#id_plataforma').val();
            var plataformaId = $('#id_dispositivo').val();
            var sensorId = $('#id_sensor').val();
            var redId = $('#id_red').val();
            var dateIni = $('#dateIni').val();
            var dateFin = $('#dateFin').val();
            var todoSensor = $('#todoSensor').is(':checked');

            data = 'csrfmiddlewaretoken={{ csrf_token }}&id_dispositivo=' + dispositivoId + '&id_plataforma=' + plataformaId + '&id_sensor=' + sensorId + '&id_red=' + redId + '&dateIni=' + dateIni + '&dateFin=' + dateFin + '&todoSensor=' + todoSensor;
            xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                var a, today;
                if (xhttp.readyState === 4 && xhttp.status === 200) {
                    a = document.createElement('a');
                    a.href = window.URL.createObjectURL(xhttp.response);
                    today = new Date();
                    a.download = "data_" + today.toDateString().split(" ").join("_") + ".xls";
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    return a.click();
                }
            };
            xhttp.open("POST", "/download-excel", true);
            xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhttp.responseType = 'blob';
            xhttp.send(data);
        });

    });
</script>

{% endblock javascripts %}