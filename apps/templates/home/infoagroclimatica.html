{% extends "layouts/base.html" %}

{% block title %} Infoagroclimatica {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<style>
    .input-group-addon {
        color: #00f2c3;
        border-color: #00f2c3;
        border: none
    }

    .input-group-addon:focus {
        outline: 0 !important
    }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="content">
    <div class="row"></div>
    {# <h1>Hello {{ firstname }}</h1> #}
    <form id="formGrafica">
        {% csrf_token %}

        {% for error in errors  %}
        <div class="alert alert-danger mb-4" role="alert">
            <strong>{{ error }}</strong>
        </div>
        {% endfor %}

        <div class="row">
            <div class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione Plataforma IoT</label>
                        {{ form.platafromas}}
                    </div>
                </div>
            </div>
            <div id="divRed" class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione Red</label>
                        <select id="id_red" class="form-control selectpicker" data-live-search="true" data-style="btn-success" name="state">
                            <option selected disabled value="0">Seleccione</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione estación/dispositivo/equipo</label>
                        <select id="id_dispositivo" class="form-control selectpicker" data-live-search="true" data-style="btn-success" onChange="getTiposInformes()" name="state">
                            <option selected disabled value="0">Seleccione</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Seleccione Informe</label>
                        <select id="id_informe" class="form-control selectpicker" data-live-search="true" data-style="btn-success" onChange="frmInforme()" name="state">
                            <option selected disabled value="0">Seleccione</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="mb-4">
                    <div class="form-group">
                        <label>Agregar</label>
                        <br>
                        <a class="btn btn-success btn-icon btn-circle btn-sm" onclick="addDiv()">
                            <i class="tim-icons icon-simple-add"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div id="frmAdd"></div>
        <div id="estacionesDiv">
        </div>
        <div class="row justify-content-md-center">
            <div class="col-lg-4">
                <input type="button" value="Generar" class="form-control btn btn-success" id="form_btn">
            </div>
            <div class="col-lg-4">
                <input type="button" value="Descargar PDF" class="form-control btn btn-warning" id="pdf_btn">
            </div>
        </div>

    </form>
    <br>
    <div class="graficas" id="graficas">
    </div>
    <!-- <div class="graficas">
        <div class="row">
            <div class="col-12">
                <div class="card card-chart">
                    <div class="card-body">
                        <div id="chart-graficaMulti" class="highcharts-background">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
</div>

<style>
    #chart-graficaMulti {
        height: 500px;
    }

    .highcharts-figure,
    .highcharts-data-table table {
        min-width: 310px;
        max-width: 800px;
        margin: 1em auto;
    }

    .highcharts-data-table table {
        font-family: Verdana, sans-serif;
        border-collapse: collapse;
        border: 1px solid #ebebeb;
        margin: 10px auto;
        text-align: center;
        width: 100%;
        max-width: 500px;
    }

    .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
    }

    .highcharts-data-table th {
        font-weight: 600;
        padding: 0.5em;
    }

    .highcharts-data-table td,
    .highcharts-data-table th,
    .highcharts-data-table caption {
        padding: 0.5em;
    }

    .highcharts-data-table thead tr,
    .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
    }

    .highcharts-data-table tr:hover {
        background: #f1f7ff;
    }

    .highcharts-background {
        fill: #ffffff00;
    }
</style>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
    var x = 'hola';
    var chart_chartBig1;
    var medida;
    var cantDivs = 0,
        contDivs = 1;
    var idsCharts = [];

    function addDiv() {
        if (cantDivs > 4) {
            general.showNotificationOwn('top', 'right', 'warning', 'INFORMES MAXIMOS ALCANZADOS', 'ERROR')
        } else {

            var html = '<div id="divAdded' + contDivs + '">' +
                '<input type="hidden" value="' + contDivs + '" id="hdTxtCont' + contDivs + '">' +
                '<div class="row">' +
                '<div class="col-lg-6">' +
                '<div class="mb-4">' +
                '<div class="form-group">' +
                '<label>Seleccione estación/dispositivo/equipo</label>' +
                '<select id="id_dispositivo' + contDivs + '" class="form-control" data-live-search="true" data-style="btn-success" onChange="getTiposInformes(' + contDivs + ')" name="state">' +
                '<option selected disabled value="0">Seleccione</option>' +
                '</select>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="col-lg-4">' +
                '<div class="mb-4">' +
                '<div class="form-group">' +
                '<label>Seleccione informe</label>' +
                '<select id="id_informe' + contDivs + '" class="form-control" data-live-search="true" data-style="btn-success" onChange="frmInforme(' + contDivs + ')" name="state">' +
                '<option selected disabled value="0">Seleccione</option>' +
                '</select>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="col-lg-2">' +
                '<div class="mb-4">' +
                '<div class="form-group">' +
                '<label>Eliminar</label>' +
                '<br>' +
                '<a class="btn btn-warning btn-icon btn-circle btn-sm" onclick="detDiv(' + contDivs + ')">' +
                '<i class="tim-icons icon-simple-delete"></i>' +
                '</a>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div id="frmAdd' + contDivs + '">' +
                '</div>' +
                '</div>';


            $('#estacionesDiv').append(html);
            getDispositivos(contDivs);
            $("#id_informe" + contDivs).selectpicker("refresh");
            ++contDivs
            ++cantDivs;
        }
    }

    function detDiv(contDiv) {
        --cantDivs;
        $('#divAdded' + contDiv).remove();
    }

    function getDispositivos(contDiv = '') {
        var plataformaId = $('#id_plataforma').val();
        var redId = $('#id_red').val();

        $.ajax({
            type: "POST",
            url: "{% url 'get-dispositivo' %}",
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'id': plataformaId,
                'id_red': redId
            },
            success: function(data) {
                let html_data = '<option  selected disabled value="0">Seleccione</option>';
                data.datos.forEach(function(data) {
                    html_data += `<option value="${data[0]}">${data[1]}</option>`
                });
                $("#id_dispositivo" + contDiv).html(html_data);
                $("#id_dispositivo" + contDiv).selectpicker("refresh");
            }
        });
    }

    function getTiposInformes(contDiv = '') {
        var plataformaId = $('#id_plataforma').val();
        var dispositivoId = $('#id_dispositivo' + contDiv).val();
        $('#frmAdd' + contDiv).html('');

        $.ajax({
            type: "POST",
            url: "{% url 'get-tipo-informes' %}",
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'id': plataformaId,
                'id_dispositivo': dispositivoId
            },
            success: function(data) {
                let html_data = '<option  selected disabled value="0">Seleccione</option>';
                data.datos.forEach(function(data) {
                    html_data += `<option value="${data[0]}">${data[1]}</option>`
                });
                $("#id_informe" + contDiv).html(html_data);
                $("#id_informe" + contDiv).selectpicker("refresh");
            }
        });

    }

    function frmInforme(contDiv = '') {
        var informeId = $('#id_informe' + contDiv).val();
        var html = '';

        switch (informeId) {
            case "1":
                html = '<div class="row">' +
                    '<div class="col-lg-2">' +
                    '<div class="mb-2">' +
                    '<div class="form-group">' +
                    '<label>Seleccione Fecha</label>' +
                    '<div class="input-group date fecha' + contDiv + '">' +
                    '<input id="fecha' + contDiv + '" type="text" class="form-control" data-style="btn-success"><span class="input-group-addon"><i class="tim-icons icon-calendar-60"></i></span>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<script>' +
                    '$(".input-group.date.fecha' + contDiv + '").datepicker({ ' +
                    'format: "yyyy",' +
                    'startView: 2,' +
                    'minViewMode: 2,' +
                    'maxViewMode: 2' +
                    '}); </' +
                    'script>';
                break;
            case "2":
            case "7":
            case "8":
            case "13":
            case "14":
            case "22":
            case "23":
            case "28":
            case "29":
                html = '<div class="row">' +
                    '<div class="col-lg-2">' +
                    '<div class="mb-2">' +
                    '<div class="form-group">' +
                    '<label>Seleccione Fecha</label>' +
                    '<div class="input-group date fecha' + contDiv + '">' +
                    '<input id="fecha' + contDiv + '" type="text" class="form-control" data-style="btn-success"><span class="input-group-addon"><i class="tim-icons icon-calendar-60"></i></span>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<script>' +
                    '$(".input-group.date.fecha' + contDiv + '").datepicker({ ' +
                    'format: "mm-yyyy",' +
                    'startView: 1,' +
                    'minViewMode: 1,' +
                    'maxViewMode: 2' +
                    '}); </' +
                    'script>';
                break;
            case "11":
            case "17":
            case "20":
            case "26":
                html = '<div class="row">' +
                    '<div class="col-lg-4">' +
                    '<div class="mb-4">' +
                    '<div class="form-group">' +
                    '<label>Seleccione Fecha</label>' +
                    '<div class="input-group" id="fecDiv' + contDiv + '">' +
                    '<span class="input-group-btn">' +
                    '<button class="btn btn-default" type="button">' +
                    '<i class="fa fa-calendar"></i>' +
                    '</button>' +
                    '</span>' +
                    '<input id="fecha' + contDiv + '" type="text" class="form-control" data-style="btn-success">' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<script>' +
                    'general.rangeDatePicker("fecDiv' + contDiv + '", "fecha' + contDiv + '", true); </' +
                    'script>';
                break;
            case "10":
                html = '<div class="row">' +
                    '<div class="col-lg-4">' +
                    '<div class="mb-4">' +
                    '<div class="form-group">' +
                    '<label>Seleccione Fecha</label>' +
                    '<div class="input-group" id="fecDiv' + contDiv + '">' +
                    '<span class="input-group-btn">' +
                    '<button class="btn btn-default" type="button">' +
                    '<i class="fa fa-calendar"></i>' +
                    '</button>' +
                    '</span>' +
                    '<input id="fecha' + contDiv + '" type="text" class="form-control" data-style="btn-success">' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="col-lg-4">' +
                    '<div class="mb-4">' +
                    '<div class="form-group">' +
                    '<label>CC</label>' +
                    '<input id="cc' + contDiv + '" type="number" value="10" min="0" class="form-control" data-style="btn-success">' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="col-lg-4">' +
                    '<div class="mb-4">' +
                    '<div class="form-group">' +
                    '<label>PMP</label>' +
                    '<input id="pmp' + contDiv + '" type="number" value="40" min="0" class="form-control" data-style="btn-success">' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<script>' +
                    'general.rangeDatePicker("fecDiv' + contDiv + '", "fecha' + contDiv + '", true); </' +
                    'script>';
                break;
        }

        $('#frmAdd' + contDiv).html(html);
    }

    function recolectData() {
        var arrResp = [];
        var resp = {};
        resp['dispositivoId'] = $('#id_dispositivo').val();
        resp['dispositivoName'] = $('#id_dispositivo option:selected').text();
        resp['informeId'] = $('#id_informe').val();
        resp['informeName'] = $('#id_informe option:selected').text();
        resp['fecha'] = $('#fecha').val();
        resp['cc'] = $('#cc').val();
        resp['pmp'] = $('#pmp').val();
        arrResp.push(resp);

        $("[id*='hdTxtCont']").each(function() {
            var resp = {};
            resp['dispositivoId'] = $('#id_dispositivo' + $(this).val()).val();
            resp['dispositivoName'] = $('#id_dispositivo' + $(this).val() + ' option:selected').text();
            resp['informeId'] = $('#id_informe' + $(this).val()).val();
            resp['informeName'] = $('#id_informe' + $(this).val() + ' option:selected').text();
            resp['fecha'] = $('#fecha' + $(this).val()).val();
            resp['cc'] = $('#cc' + $(this).val()).val();
            resp['pmp'] = $('#pmp' + $(this).val()).val();
            arrResp.push(resp);
        });
        return arrResp;
    }

    function isIEBrowser() {
        var ieBrowser;
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");

        if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./)) // Internet Explorer
        {
            ieBrowser = true;
        } else //Other browser
        {
            // console.log('Other Browser');
            ieBrowser = false;
        }

        return ieBrowser;
    };

    $(document).ready(function() {
        $(".graficas").hide()
        $("#divRed").hide();

        $("#id_plataforma").change(function() {
            var plataformaId = $(this).val();
            $('#estacionesDiv').html('');

            if (plataformaId == 4) {
                $("#divRed").show();
                $.ajax({
                    type: "POST",
                    url: "{% url 'get-red' %}",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'id': plataformaId
                    },
                    success: function(data) {
                        let html_data = '<option selected disabled value="0">Seleccione</option>';
                        data.datos.forEach(function(data) {
                            html_data += `<option value="${data[0]}">${data[1]}</option>`
                        });
                        $("#id_red").html(html_data);
                        $("#id_red").selectpicker("refresh");
                    }
                });
            } else {
                $("#divRed").hide();
                getDispositivos();
            }

        });

        $("#id_red").change(function() {
            $('#estacionesDiv').html('');
            getDispositivos();

        });

        $("#form_btn").click(function() {
            var plataformaId = $('#id_plataforma').val();
            $('.graficas').html('');

            $.ajax({
                type: "POST",
                url: "{% url 'create-informe' %}",
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'id_plataforma': plataformaId,
                    'datos': JSON.stringify(recolectData())
                },
                success: function(data) {
                    if (data.data == 0) {
                        general.showNotificationOwn('top', 'right', 'warning', 'Datos Incompletos o Sin Informacion', 'ERROR')
                        $(".graficas").hide();
                    } else {
                        $(".graficas").show();
                        var i = 1;
                        idsCharts = [];

                        data.data.forEach(grafica => {

                            idsCharts.push("chart-grafica" + i + "");
                            html = '<div class="graficas">' +
                                '<div class="row">' +
                                '<div class="col-12">' +
                                '<div class="card card-chart">' +
                                '<div class="card-body">' +
                                '<div id="chart-grafica' + i + '" class="highcharts-background">' +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>';
                            $('.graficas').append(html);
                            general.initMultipleAxesHighCharts('chart-grafica' + i, grafica.vertical, grafica.horizontal, grafica.medidas, grafica.sensores, ('Grafico de ' + grafica.nombre), null, grafica.tipo, grafica.plotBand);

                            i = i + 1;

                        });


                    }
                }
            });
        });

        $("#pdf_btn").click(function() {

            var doc = new jsPDF('portrait', 'pt', 'a4', true);
            var elementHandler = {
                '#ignorePDF': function(element, renderer) {
                    return true;
                }
            };

            var source = document.getElementById("graficass");
            doc.fromHTML(source, 15, 50, {
                'width': 560,
                'elementHandlers': elementHandler
            });

            var DOMURL = window.URL || window.webkitURL || window;
            var elements = idsCharts;

            var today = new Date().toLocaleDateString('en-GB');
            var text = 'Informe Agroclimatico - Generado ' + today;
            var xOffset = (doc.internal.pageSize.width / 2) - (doc.getStringUnitWidth(text) * doc.internal.getFontSize() / 2);
            doc.text(text, xOffset, 20, );

            // console.log(xx);
            for (let i in elements) {


                let svg = document.querySelectorAll('svg');
                let canvas = document.createElement('canvas');
                let canvasIE = document.createElement('canvas');
                let context = canvas.getContext('2d');

                let data1 = (new XMLSerializer()).serializeToString(svg[i]);

                canvg(canvas, data1);
                let svgBlob = new Blob([data1], {
                    type: 'image/svg+xml;charset=utf-8'
                });

                let url = DOMURL.createObjectURL(svgBlob);

                let img = new Image();
                img.src = url;
                img.onload = function() {
                    context.canvas.width = $("#" + elements[i]).find('svg').width();
                    context.canvas.height = $("#" + elements[i]).find('svg').height();

                    context.drawImage(img, 0, 0);
                    // freeing up the memory as image is drawn to canvas
                    DOMURL.revokeObjectURL(url);

                    var dataUrl;
                    if (isIEBrowser()) { // Check of IE browser 
                        var svg = $(elements[i]).highcharts().container.innerHTML;
                        canvg(canvasIE, svg[i]);
                        dataUrl = canvasIE.toDataURL('image/JPEG');
                    } else {
                        dataUrl = canvas.toDataURL('image/jpeg');
                    }

                    if (elements.length == 1) {
                        doc.addImage(dataUrl, 'JPEG', 20, 50, 550, 300);
                        doc.addPage();
                    } else {

                        if ((parseInt(i) + 1) % 2 == 0) {
                            doc.addImage(dataUrl, 'JPEG', 20, 400, 550, 300);
                        } else {
                            doc.addImage(dataUrl, 'JPEG', 20, 50, 550, 300);
                        }

                        if ((parseInt(i) + 1) == elements.length || ((parseInt(i) + 1) % 2 == 0)) {
                            doc.addPage();
                        }

                    }

                    // if (elements.length == 1 || !(i % 2 == 0)) {
                    //     doc.addImage(dataUrl, 'JPEG', 20, 50, 550, 300);
                    //     if (elements.length == 1) {
                    //         doc.addPage();
                    //     }

                    // } else {
                    //     doc.addImage(dataUrl, 'JPEG', 20, 400, 550, 300);
                    //     doc.addPage();
                    // }
                };

            }

            setTimeout(function() {

                var pageCount = doc.internal.getNumberOfPages();
                doc.deletePage(pageCount)
                doc.save('Ingroagroclimatica_' + today + '.pdf');
            }, 1000);

        });

    });
</script>

{% endblock javascripts %}